<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>nitools: Utility Functions for the Analysis of Structural Neuroimaging Data in GNU R</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">nitools: Utility Functions for the Analysis of Structural Neuroimaging Data in GNU R</h1>



<p>In this document, we demonstrate some high-level functions for loading and analysing structural neuroimaging data preprocessed with <a href="https://surfer.nmr.mgh.harvard.edu">FreeSurfer</a>. FreeSurfer stores its output in a directory structure with fixed subfolder names. This package implements several high-level functions that allow the user to access surface-based brain structure data for large groups of subjects with very little code. It also supports the computation of statistics for individual brain structures or brain atlas regions for brain morphometry measures. Statistical analysis can then be performed using standard methods implemented in other packages.</p>
<p>Note: While this packages provides an abstract access layer to neuroimaging data, it does <em>not</em> implement file readers. It uses the ‘freesurferformats’ package in the background to parse the file formats.</p>
<div id="accessing-morphometry-data-for-groups-of-subjects" class="section level2">
<h2>Accessing morphometry data for groups of subjects</h2>
<p>To open a single file directly, all you would need is ‘freesurferformats’:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">library</span>(<span class="st">&quot;freesurferformats&quot;</span>);
    cortical_thickness =<span class="st"> </span><span class="kw">read.fs.morph</span>(<span class="st">&quot;study_dir/subject1/surf/lh.thickness&quot;</span>);</code></pre></div>
<div id="native-space" class="section level3">
<h3>Native space</h3>
<p>The nitools package provides a high-level interface to access data for groups of subjects. Here, we compute the mean thickness for each subject in native space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">library</span>(<span class="st">&quot;nitools&quot;</span>);
    subjects_dir =<span class="st"> </span><span class="kw">path.expand</span>(<span class="st">&quot;~/data/study1&quot;</span>)
    subjects_list =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;subject1&quot;</span>, <span class="st">&quot;subject2&quot;</span>, <span class="st">&quot;subject3&quot;</span>, <span class="st">&quot;subject4&quot;</span>, <span class="st">&quot;subject5&quot;</span>)
    mean_thickness_lh =<span class="st"> </span><span class="kw">group.morph.agg.native</span>(subjects_dir, subjects_list, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="dt">agg_fun=</span>mean)</code></pre></div>
</div>
<div id="standard-space" class="section level3">
<h3>Standard space</h3>
<p>Here, we compute the mean thickness for each subject in standard space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">library</span>(<span class="st">&quot;nitools&quot;</span>);
    subjects_dir =<span class="st"> </span><span class="kw">path.expand</span>(<span class="st">&quot;~/data/study1&quot;</span>)
    subjects_list =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;subject1&quot;</span>, <span class="st">&quot;subject2&quot;</span>, <span class="st">&quot;subject3&quot;</span>, <span class="st">&quot;subject4&quot;</span>, <span class="st">&quot;subject5&quot;</span>)
    mean_thickness_lh =<span class="st"> </span><span class="kw">group.morph.agg.standard</span>(subjects_dir, subjects_list, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="dt">fwhm=</span><span class="st">&quot;10&quot;</span>, <span class="dt">agg_fun=</span>mean)</code></pre></div>
</div>
</div>
<div id="aggregating-over-atlas-regions" class="section level2">
<h2>Aggregating over atlas regions</h2>
<p>When working with native space data for groups, vertex-wise comparison is not possible and one if often interested in aggregating data or summary statistics. Obtaining these for a group becomes easy with ‘nitools’:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  subjects_dir =<span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;study_dir&quot;</span>)
  subjects_list =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;subject1&quot;</span>, <span class="st">&quot;subject2&quot;</span>, <span class="st">&quot;subject3&quot;</span>)  <span class="co"># You may want to read them from a subjects file instead if you have many</span>
  data =<span class="st"> </span><span class="kw">group.multimorph.agg.native</span>(subjects_dir, subjects_list, <span class="kw">c</span>(<span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;area&quot;</span>, <span class="st">&quot;volume&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;lh&quot;</span>, <span class="st">&quot;rh&quot;</span>), <span class="dt">agg_fun =</span> mean);</code></pre></div>
<p>This gives you a dataframe that contains the following columns:</p>
<ul>
<li><code>subject_id</code></li>
<li><code>hemi</code></li>
<li><code>measure_name</code></li>
<li><code>measure_value</code></li>
</ul>
<p>The measure values are the mean thickness/area/volume over all vertices of the subject, computed from the respective native space morphometry files (e.g., ‘subject1/surf/lh.thickness’, ‘subject2/surf/lh.thickness’, and so on).</p>
<p>Note that you can get short format by setting ‘cast = FALSE’, which will result in a dataframe with the following columns instead:</p>
<ul>
<li><code>subject_id</code></li>
<li><code>lh.thickness</code></li>
<li><code>rh.thickness</code></li>
<li><code>lh.area</code></li>
<li><code>eh.area</code></li>
<li><code>lh.volume</code></li>
<li><code>rh.volume</code></li>
</ul>
<p>You could do the same in standard space with <code>group.multimorph.agg.native()</code>, even though it’s not very common.</p>
</div>
<div id="mapping-one-result-value-to-each-brain-atlas-region" class="section level2">
<h2>Mapping one result value to each brain atlas region</h2>
<p>Mapping a single value to an atlas region of a subject (usually a template subject like fsaverage) is useful to display results, like p values or effect sizes, on the brain surface. Here is an example script that uses nitools to do that:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;nitools&quot;</span>)

hemi =<span class="st"> &quot;lh&quot;</span>               <span class="co"># 'lh' or 'rh'</span>
atlas =<span class="st"> &quot;aparc&quot;</span>           <span class="co"># an atlas, e.g., 'aparc', 'aparc.a2009s', 'aparc.DKTatlas'</span>

template_subjects_dir =<span class="st"> &quot;/Applications/freesurfer/subjects&quot;</span>;    <span class="co"># Some directory where we can find fsaverage. This can be omitted if FREESURFER_HOME is set, the function will find fsaverage in there by default.</span>

<span class="co"># One can also retrieve all region names of an atlas. This would get all 36 aparc regions:</span>
region_names_aparc =<span class="st"> </span>nitools<span class="op">::</span><span class="kw">get.atlas.region.names</span>(<span class="st">'aparc'</span>, <span class="dt">template_subjects_dir=</span>template_subjects_dir);
region_value_list =<span class="st"> </span><span class="kw">as.list</span>(<span class="kw">rnorm</span>(<span class="kw">length</span>(region_names_aparc), <span class="dt">mean=</span><span class="dv">5</span>, <span class="dt">sd=</span><span class="fl">1.5</span>)); <span class="co"># assign some random normal values for this example. One would put effect size values or whatever here. The order of values has to match the order of the region names.</span>
<span class="kw">names</span>(region_value_list) =<span class="st"> </span>region_names_aparc;    <span class="co"># Assign the names to the values.</span>

ret =<span class="st"> </span>nitools<span class="op">::</span><span class="kw">fs.write.region.values.fsaverage</span>(hemi, atlas, region_value_list, <span class="dt">output_file=</span><span class="st">&quot;/tmp/spread.mgz&quot;</span>, <span class="dt">template_subjects_dir=</span>template_subjects_dir, <span class="dt">show_freeview_tip=</span><span class="ot">TRUE</span>);</code></pre></div>
<p>This code will write an MGZ file that can be visualized in FreeView or Matlab/Surfstat.</p>
</div>
<div id="rendering-surfaces-and-data-in-gnu-r-for-a-quick-preview" class="section level2">
<h2>Rendering surfaces and data in GNU R for a quick preview</h2>
<p>You can visualize data directly in GNU R in different ways. If you want an interactive 3-dimensional view of the brain surface, use the <code>rgl</code> package. It’s a simple mesh renderer that uses an OpenGL backend. It’s fast enough to draw meshes with &gt; 300.000 vertices even on old laptops. The <code>rgl</code> package is not a dependency of <code>nitools</code>, so you’ll have to install it.</p>
<p>Let’s first load a mesh and an annotation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">library</span>(<span class="st">&quot;nitools&quot;</span>);
    <span class="kw">library</span>(<span class="st">&quot;freesurferformats&quot;</span>);   <span class="co"># a dependency of nitools, so you have it already</span>
    <span class="kw">library</span>(<span class="st">&quot;rgl&quot;</span>);

    sample_subject_dir =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">Sys.getenv</span>(<span class="st">&quot;FREESURFER_HOME&quot;</span>), <span class="st">&quot;subjects&quot;</span>, <span class="st">&quot;bert&quot;</span>);       <span class="co"># or whatever you prefer</span>

    surf =<span class="st"> </span><span class="kw">fs.read.surface</span>(<span class="kw">file.path</span>(sample_subject_dir, <span class="st">&quot;surf&quot;</span>, <span class="st">&quot;lh.white&quot;</span>));
    annot =<span class="st"> </span><span class="kw">read.fs.annot</span>(<span class="kw">file.path</span>(sample_subject_dir, <span class="st">&quot;label&quot;</span>, <span class="st">&quot;lh.aparc.annot&quot;</span>));</code></pre></div>
<p>Now we can render:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mesh =<span class="st"> </span><span class="kw">tmesh3d</span>(<span class="kw">unlist</span>(surf<span class="op">$</span>vertices), <span class="kw">unlist</span>(surf<span class="op">$</span>faces), <span class="dt">homogeneous=</span><span class="ot">FALSE</span>);
<span class="kw">rgl.open</span>();
col =<span class="st"> </span>annot<span class="op">$</span>hex_colors_rgb;
<span class="kw">wire3d</span>(mesh, <span class="dt">col=</span>col, <span class="dt">meshcolor=</span><span class="st">&quot;vertices&quot;</span>);</code></pre></div>
<p>If you prefer a 2D view that shows brain regions from different viewports in cartoon style, you may want to try the <code>ggseg</code> package instead.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
